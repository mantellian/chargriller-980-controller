esphome:
  name: chargriller-980
  on_boot:
    priority: -100
    then:
      - lambda: |-
          id(temp_setpoint_value) = 225.0;
          id(pending_setpoint) = 225.0;
          id(setpoint_being_adjusted) = false;

esp32:
  board: esp32dev
  framework:
    type: arduino
  variant: esp32

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  min_auth_mode: WPA2
  power_save_mode: none
  ap:
    ssid: "CharGriller-980"
    password: "chargriller980"

captive_portal:
logger:
  level: DEBUG

api:
  encryption:
    key: !secret api_encryption_key

ota:
  platform: esphome
  password: !secret ota_password

web_server:
  port: 80

# -------------------------------------------------------
# Global Variables
# -------------------------------------------------------
globals:
  - id: temp_setpoint_value
    type: float
    restore_value: yes
    initial_value: '225.0'
  - id: pending_setpoint
    type: float
    restore_value: no
    initial_value: '225.0'
  - id: setpoint_being_adjusted
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: buzzer_enabled
    type: bool
    restore_value: yes
    initial_value: 'true'
  - id: alarm_silenced
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: high_temp_alarm_active
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: low_temp_alarm_active
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: fan_error_active
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: current_fan_duty
    type: float
    restore_value: no
    initial_value: '0.0'

# -------------------------------------------------------
# SPI – MAX31855 Thermocouple Amplifier
# -------------------------------------------------------
spi:
  clk_pin: GPIO18
  miso_pin: GPIO19

sensor:
  - platform: max31855
    name: "Pit Temperature"
    cs_pin: GPIO21
    update_interval: 1s
    id: pit_temp
    filters:
      - sliding_window_moving_average:
          window_size: 3
          send_every: 1
    on_value:
      then:
        - lambda: |-
            if (x >= 800.0) {
              id(grill_climate).mode = CLIMATE_MODE_OFF;
              ESP_LOGW("safety", "EMERGENCY: Temperature exceeded 800°F! Shutting down.");
            }

  - platform: pulse_counter
    pin: GPIO17
    name: "Fan RPM"
    unit_of_measurement: "RPM"
    update_interval: 1s
    id: fan_rpm

  - platform: rotary_encoder
    name: "Encoder Position"
    id: encoder_position
    internal: true
    pin_a: 
      number: GPIO32
      mode: INPUT_PULLUP
    pin_b: 
      number: GPIO33
      mode: INPUT_PULLUP
    min_value: 0
    max_value: 750
    resolution: 1
    on_value:
      then:
        - lambda: |-
            id(pending_setpoint) = x;
            id(setpoint_being_adjusted) = true;
        - script.execute: setpoint_timeout

# -------------------------------------------------------
# TM1637 Displays
# -------------------------------------------------------
display:
  - platform: tm1637
    id: tm1637_current
    clk_pin: GPIO23
    dio_pin: GPIO26
    update_interval: 0.5s
    lambda: |-
      if (id(fan_error_active)) it.print("ERF");
      else if (id(high_temp_alarm_active)) it.print(" HI");
      else if (id(low_temp_alarm_active)) it.print("LO");
      else if (id(lid_switch).state) it.print("OPN");
      else if (!isnan(id(pit_temp).state)) it.printf("%.0f", id(pit_temp).state);
      else it.print("---");

  - platform: tm1637
    id: tm1637_setpoint
    clk_pin: GPIO25
    dio_pin: GPIO22
    update_interval: 0.5s
    lambda: |-
      it.printf("%.0f", id(setpoint_being_adjusted) ? id(pending_setpoint) : id(temp_setpoint_value));

# -------------------------------------------------------
# Door Switch & Encoder Button
# -------------------------------------------------------
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO13
      mode: INPUT_PULLUP
    id: lid_switch
    name: "Lid Switch"
    device_class: opening
    filters:
      - invert: {}
    on_press:
      then: - climate.control: {id: grill_climate, mode: "OFF"}
    on_release:
      then: - climate.control: {id: grill_climate, mode: "HEAT"}

  - platform: gpio
    pin:
      number: GPIO27
      mode: INPUT_PULLUP
    id: encoder_button
    name: "Encoder Button"
    filters:
      - invert: {}
    on_press:
      then:
        - lambda: |-
            bool any_alarm = id(fan_error_active) || id(high_temp_alarm_active) || 
                             id(low_temp_alarm_active) || id(buzzer_switch).state;
            if (any_alarm) {
              id(alarm_silenced) = true;
              id(buzzer_switch).turn_off();
              ESP_LOGI("buzzer", "Alarm silenced via encoder button");
            } else if (id(setpoint_being_adjusted)) {
              id(temp_setpoint_value) = id(pending_setpoint);
              id(setpoint_being_adjusted) = false;
              auto call = id(grill_climate).make_call();
              call.set_target_temperature(id(temp_setpoint_value));
              call.perform();
              ESP_LOGI("setpoint", "Temperature setpoint confirmed: %.0f°F", id(temp_setpoint_value));
            }

# -------------------------------------------------------
# Scripts
# -------------------------------------------------------
script:
  - id: setpoint_timeout
    mode: restart
    then:
      - delay: 5s
      - lambda: |-
          if (id(setpoint_being_adjusted)) {
            id(temp_setpoint_value) = id(pending_setpoint);
            id(setpoint_being_adjusted) = false;
            auto call = id(grill_climate).make_call();
            call.set_target_temperature(id(temp_setpoint_value));
            call.perform();
            ESP_LOGI("setpoint", "Temperature setpoint auto-confirmed: %.0f°F", id(temp_setpoint_value));
          }

  - id: sos_beep
    mode: queued
    then:
      - lambda: |-
          for (int i=0;i<3;i++) { id(buzzer).turn_on(); delay(200); id(buzzer).turn_off(); delay(200); }
          for (int i=0;i<3;i++) { id(buzzer).turn_on(); delay(600); id(buzzer).turn_off(); delay(200); }
          for (int i=0;i<3;i++) { id(buzzer).turn_on(); delay(200); id(buzzer).turn_off(); delay(200); }

  - id: alarm_beep
    mode: restart
    then:
      - while:
          condition: lambda: 'return id(buzzer_enabled) && !id(alarm_silenced);'
          then:
            - script.execute: sos_beep
            - delay: 3s

# -------------------------------------------------------
# Fan PWM Output & Control
# -------------------------------------------------------
output:
  - platform: ledc
    pin: GPIO16
    frequency: 25000 Hz
    id: fan_pwm

fan:
  - platform: speed
    output: fan_pwm
    name: "Blower Fan"
    id: blower

# -------------------------------------------------------
# PID Climate Control
# -------------------------------------------------------
climate:
  - platform: pid
    id: grill_climate
    name: "Grill Climate"
    sensor: pit_temp
    default_target_temperature: 225°F
    heat_output: fan_pwm
    on_state:
      - lambda: |-
          id(current_fan_duty) = x;
    control_parameters:
      kp: 0.3
      ki: 0.005
      kd: 0.8
      output_averaging_samples: 5
      derivative_averaging_samples: 5
    deadband_parameters:
      threshold_high: 2°F
      threshold_low: -2°F
      kp_multiplier: 0.0
      ki_multiplier: 0.0
      kd_multiplier: 0.0
    visual:
      min_temperature: 150°F
      max_temperature: 750°F
      temperature_step: 5°F

# -------------------------------------------------------
# Buzzer & Switches
# -------------------------------------------------------
switch:
  - platform: gpio
    pin: GPIO4
    id: buzzer
    internal: true

  - platform: template
    name: "Buzzer Active"
    id: buzzer_switch
    internal: true
    optimistic: true

  - platform: template
    name: "Buzzer Enabled"
    id: buzzer_enable_switch
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
    on_turn_on: lambda: 'id(buzzer_enabled) = true;'
    on_turn_off: lambda: |-
      id(buzzer_enabled) = false;
      id(buzzer_switch).turn_off();

# -------------------------------------------------------
# Buttons
# -------------------------------------------------------
button:
  - platform: template
    name: "PID Autotune"
    on_press:
      - climate.pid.autotune:
          id: grill_climate
          noiseband: 1.0
          positive_output: 100%
          negative_output: 0%

  - platform: template
    name: "Silence Alarm"
    on_press:
      - lambda: |-
          id(alarm_silenced) = true;
          id(buzzer_switch).turn_off();
          ESP_LOGI("buzzer", "Alarm silenced via button")

# -------------------------------------------------------
# Alarm Monitoring Intervals
# -------------------------------------------------------
interval:
  - interval: 10s
    then:
      - lambda: |-
          auto now = millis();
          float current_temp = id(pit_temp).state;
          float setpoint = id(temp_setpoint_value);

          // High temperature
          static uint32_t high_temp_start = 0;
          if (current_temp > setpoint + 50.0) {
            if (!high_temp_start) high_temp_start = now;
            else if ((now - high_temp_start > 180000) && !id(high_temp_alarm_active)) {
              id(high_temp_alarm_active) = true;
              id(alarm_silenced) = false;
              id(buzzer_switch).turn_on();
              id(alarm_beep).execute();
              ESP_LOGW("alarm","HIGH TEMP: %.0f°F (setpoint %.0f°F)", current_temp,setpoint);
            }
          } else { high_temp_start=0; if(id(high_temp_alarm_active) && current_temp <= setpoint+25) id(high_temp_alarm_active)=false; }

          // Low temperature
          static uint32_t low_temp_start = 0;
          if (current_temp < setpoint - 50.0) {
            if (!low_temp_start) low_temp_start = now;
            else if ((now - low_temp_start > 180000) && !id(low_temp_alarm_active)) {
              id(low_temp_alarm_active) = true;
              id(alarm_silenced) = false;
              id(buzzer_switch).turn_on();
              id(alarm_beep).execute();
              ESP_LOGW("alarm","LOW TEMP: %.0f°F (setpoint %.0f°F)", current_temp,setpoint);
            }
          } else { low_temp_start=0; if(id(low_temp_alarm_active) && current_temp >= setpoint-25) id(low_temp_alarm_active)=false; }

  - interval: 2s
    then:
      - lambda: |-
          auto climate_mode = id(grill_climate).mode;
          float fan_duty = id(current_fan_duty);
          float rpm = id(fan_rpm).state;
          bool fan_should_run = (climate_mode == CLIMATE_MODE_HEAT) && (fan_duty > 0.10);
          bool fan_is_running = rpm >= 100.0;
          if (fan_should_run && !fan_is_running && !id(fan_error_active)) {
            id(fan_error_active)=true;
            id(alarm_silenced)=false;
            id(buzzer_switch).turn_on();
            id(alarm_beep).execute();
            ESP_LOGE("alarm","FAN ERROR: RPM=%.0f (duty %.1f%%)", rpm, fan_duty*100);
          } else if (id(fan_error_active) && fan_is_running) id(fan_error_active)=false;
