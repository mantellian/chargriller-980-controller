esphome:
  name: chargriller-980
  platform: ESP32
  board: esp32dev

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: none
  ap:
    ssid: "CharGriller-980"
    password: "chargriller980"

captive_portal:

logger:
  level: DEBUG

api:
  encryption:
    key: !secret api_encryption_key

ota:
  password: !secret ota_password

web_server:
  port: 80

spi:
  clk_pin: GPIO18
  miso_pin: GPIO19

globals:
  - id: door_override
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: error_code
    type: std::string
    restore_value: no
    initial_value: '""'
  - id: display_mode
    type: int
    restore_value: no
    initial_value: '0'

# --------------------------
# Temperature Sensor
# --------------------------
max31855:
  - platform: max31855
    name: "Smoker Temperature"
    id: smoker_temp
    cs_pin: GPIO21
    update_interval: 1s
    filters:
      - sliding_window_moving_average:
          window_size: 5
          send_every: 1

# --------------------------
# Fan RPM Sensor
# --------------------------
sensor:
  - platform: pulse_counter
    pin:
      number: GPIO17
      mode: INPUT_PULLUP
    name: "Fan RPM"
    id: fan_rpm
    unit_of_measurement: 'RPM'
    filters:
      - multiply: 0.5
    update_interval: 2s
    on_value:
      then:
        - script.execute: check_fan

  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

  - platform: rotary_encoder
    name: "Setpoint Encoder"
    id: setpoint_encoder
    pin_a: GPIO32
    pin_b: GPIO33
    resolution: 2
    on_value:
      then:
        - lambda: |-
            float current_target = id(smoker_pid).target_temperature;
            float new_target = current_target + (x * 5);
            new_target = std::max(150.0f, std::min(700.0f, new_target));
            auto call = id(smoker_pid).make_call();
            call.set_target_temperature(new_target);
            call.perform();
            id(setpoint_encoder).publish_state(0);

# --------------------------
# Binary Sensors
# --------------------------
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO13
      mode: INPUT_PULLUP
      inverted: true
    name: "Door Switches"
    id: door_switches
    filters:
      - delayed_on: 100ms
      - delayed_off: 100ms
    on_press:
      then:
        - if:
            condition:
              lambda: 'return !id(door_override);'
            then:
              - logger.log: "Door opened - stopping fan"
              - output.turn_off: fan_output
    on_release:
      then:
        - logger.log: "Door closed - resuming normal operation"

  - platform: gpio
    pin:
      number: GPIO14
      mode: INPUT_PULLUP
      filters:
        - delayed_on: 50ms
    name: "PID Enable Button"
    id: pid_button
    on_multi_click:
      - timing:
          - ON for at least 2s
        then:
          - logger.log: "PID toggle (long press)"
          - if:
              condition:
                lambda: 'return id(smoker_pid).mode == CLIMATE_MODE_OFF;'
              then:
                - climate.control:
                    id: smoker_pid
                    mode: HEAT
                - logger.log: "PID enabled"
              else:
                - climate.control:
                    id: smoker_pid
                    mode: OFF
                - logger.log: "PID disabled"
                - output.turn_off: fan_output

  - platform: gpio
    pin:
      number: GPIO27
      mode: INPUT_PULLUP
      inverted: true
    name: "Rotary Button"
    id: rotary_button
    filters:
      - delayed_on: 50ms
    on_press:
      then:
        - logger.log: "Rotary button pressed"
        - lambda: |-
            id(door_override) = !id(door_override);
            if (id(door_override)) {
              ESP_LOGI("main", "Door override ENABLED");
            } else {
              ESP_LOGI("main", "Door override DISABLED");
            }

# --------------------------
# Outputs
# --------------------------
output:
  - platform: ledc
    pin: GPIO16
    id: fan_output
    frequency: 25000Hz
    min_power: 0.0
    max_power: 1.0

  - platform: gpio
    pin: GPIO4
    id: beeper_output

# --------------------------
# Fan Speed Slider
# --------------------------
number:
  - platform: template
    name: "Fan Speed"
    id: fan_speed
    min_value: 0
    max_value: 100
    step: 1
    unit_of_measurement: "%"
    mode: slider

# --------------------------
# PID Climate Control
# --------------------------
climate:
  - platform: pid
    name: "Smoker PID"
    id: smoker_pid
    sensor: smoker_temp
    default_target_temperature: 225°F
    heat_output: fan_output
    control_parameters:
      kp: 0.5
      ki: 0.001
      kd: 10.0
      output_averaging_samples: 5
      derivative_averaging_samples: 5
    visual:
      min_temperature: 150°F
      max_temperature: 700°F
      temperature_step: 5°F
    deadband_parameters:
      threshold_high: 2°F
      threshold_low: -2°F
    on_state:
      - lambda: |-
          float output = id(fan_output).get_state() * 100;
          id(fan_speed).publish_state(output);

# --------------------------
# TM1637 4-Digit LED Displays
# --------------------------
display:
  - platform: tm1637
    id: display_current
    clk_pin: GPIO25
    dio_pin: GPIO26
    brightness: 7
    update_interval: 1s
    lambda: |-
      it.print(0, id(smoker_temp).state);

  - platform: tm1637
    id: display_setpoint
    clk_pin: GPIO27
    dio_pin: GPIO14
    brightness: 7
    update_interval: 1s
    lambda: |-
      it.print(0, id(smoker_pid).target_temperature);

# --------------------------
# Text Sensors
# --------------------------
text_sensor:
  - platform: template
    name: "Error Code"
    id: error_text
    lambda: |-
      return id(error_code);

  - platform: template
    name: "PID Autotune Disclaimer"
    id: pid_autotune_disclaimer
    lambda: |-
      return "⚠️ Autotune will run 30-60 minutes and may overshoot temperatures. Use with caution!";

# --------------------------
# Switches
# --------------------------
switch:
  - platform: template
    name: "Door Override"
    id: door_override_switch
    lambda: |-
      return id(door_override);
    turn_on_action:
      - globals.set:
          id: door_override
          value: 'true'
      - logger.log: "Door override enabled via switch"
    turn_off_action:
      - globals.set:
          id: door_override
          value: 'false'
      - logger.log: "Door override disabled via switch"

# --------------------------
# Buttons
# --------------------------
button:
  - platform: template
    name: "PID Autotune"
    on_press:
      - logger.log: "WARNING: Autotune started - see PID Autotune Disclaimer"
      - climate.pid.autotune:
          id: smoker_pid

# --------------------------
# Scripts
# --------------------------
script:
  - id: alert_sos
    mode: single
    then:
      - lambda: |-
          int pattern[] = {150,150,150,350,450,450,450,350,150,150,150,150,150,150};
          for(int i=0;i<14;i++){
            output.turn_on(id(beeper_output));
            delay(pattern[i]);
            output.turn_off(id(beeper_output));
            delay(pattern[i]);
          }

  - id: check_fan
    mode: single
    then:
      - lambda: |-
          if(id(smoker_pid).mode != CLIMATE_MODE_OFF && id(fan_speed).state > 20 && id(fan_rpm).state < 300) {
            id(error_code) = "ERF";
            script.execute(alert_sos);
          } else if(id(error_code) == "ERF" && id(fan_rpm).state >= 300) {
            id(error_code) = "";
          }

  - id: update_displays
    mode: single
    then:
      - lambda: |-
          ESP_LOGI("display", "Current: %.1f°F, Setpoint: %.1f°F", 
                   id(smoker_temp).state, 
                   id(smoker_pid).target_temperature);

# --------------------------
# Intervals
# --------------------------
interval:
  - interval: 1s
    then:
      - script.execute: update_displays

  - interval: 5s
    then:
      - script.execute: check_fan
