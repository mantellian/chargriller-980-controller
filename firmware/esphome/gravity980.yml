esphome:
  name: chargriller-980
  platform: ESP32
  board: esp32dev

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: none  # Disable power saving for best WiFi performance
  
  # Use static IP if your grill is on a different subnet or for more reliable connections
  # use_address: 192.168.1.100 # Uncomment and set your desired IP address:
  
  # Enable fallback hotspot in case wifi connection fails
  ap:
    ssid: "CharGriller-980"
    password: "chargriller980"

captive_portal:

# Enable logging
logger:
  level: DEBUG

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

ota:
  password: !secret ota_password

# Web server for standalone control
web_server:
  port: 80

# I2C for potential future sensors
# i2c:
#   sda: GPIO21
#   scl: GPIO22

# SPI for MAX31855 thermocouple
spi:
  clk_pin: GPIO18
  miso_pin: GPIO19

# Global variables
globals:
  - id: door_override
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: error_code
    type: std::string
    restore_value: no
    initial_value: '""'
  - id: display_mode
    type: int
    restore_value: no
    initial_value: '0'  # 0=normal, 1=error, 2=menu

# MAX31855 Thermocouple Amplifier
max31855:
  - platform: max31855
    name: "Smoker Temperature"
    id: smoker_temp
    cs_pin: GPIO21
    update_interval: 1s
    filters:
      - sliding_window_moving_average:
          window_size: 5
          send_every: 1

# Fan tachometer (pulse counter)
sensor:
  - platform: pulse_counter
    pin: 
      number: GPIO17
      mode: INPUT_PULLUP
    name: "Fan RPM"
    id: fan_rpm
    unit_of_measurement: 'RPM'
    filters:
      - multiply: 0.5  # Adjust based on fan pulses per revolution
    update_interval: 2s
    on_value:
      then:
        - if:
            condition:
              lambda: |-
                return id(smoker_pid).mode != CLIMATE_MODE_OFF && 
                       id(fan_speed).state > 20 && 
                       x < 300;  // RPM threshold for error
            then:
              - logger.log: "Fan failure detected!"
              - globals.set:
                  id: error_code
                  value: '"ERF"'
              - script.execute: alert_sos

  # WiFi signal strength
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s

# Binary sensors for switches
binary_sensor:
  # Door switches (wired in series)
  - platform: gpio
    pin:
      number: GPIO13
      mode: INPUT_PULLUP
      inverted: true
    name: "Door Switches"
    id: door_switches
    filters:
      - delayed_on: 100ms
      - delayed_off: 100ms
    on_press:
      then:
        - if:
            condition:
              lambda: 'return !id(door_override);'
            then:
              - logger.log: "Door opened - stopping fan"
              - output.turn_off: fan_output
    on_release:
      then:
        - logger.log: "Door closed - resuming normal operation"

  # PID Enable Button (long press)
  - platform: gpio
    pin:
      number: GPIO14
      mode: INPUT_PULLUP
      inverted: true
    name: "PID Enable Button"
    id: pid_button
    filters:
      - delayed_on: 50ms
    on_multi_click:
      - timing:
          - ON for at least 2s
        then:
          - logger.log: "PID toggle (long press)"
          - if:
              condition:
                lambda: 'return id(smoker_pid).mode == CLIMATE_MODE_OFF;'
              then:
                - climate.control:
                    id: smoker_pid
                    mode: HEAT
                - logger.log: "PID enabled"
              else:
                - climate.control:
                    id: smoker_pid
                    mode: "OFF"
                - logger.log: "PID disabled"
                - output.turn_off: fan_output

  # Rotary encoder
  - platform: gpio
    pin:
      number: GPIO32
      mode: INPUT_PULLUP
    id: rotary_clk
    
  - platform: gpio
    pin:
      number: GPIO33
      mode: INPUT_PULLUP
    id: rotary_dt

  # Rotary encoder button
  - platform: gpio
    pin:
      number: GPIO27
      mode: INPUT_PULLUP
      inverted: true
    name: "Rotary Button"
    id: rotary_button
    filters:
      - delayed_on: 50ms
    on_press:
      then:
        - logger.log: "Rotary button pressed"
        # Toggle door override
        - lambda: |-
            id(door_override) = !id(door_override);
            if (id(door_override)) {
              ESP_LOGI("main", "Door override ENABLED");
            } else {
              ESP_LOGI("main", "Door override DISABLED");
            }

# Rotary encoder sensor
sensor:
  - platform: rotary_encoder
    name: "Setpoint Encoder"
    id: setpoint_encoder
    pin_a: GPIO32
    pin_b: GPIO33
    resolution: 2
    on_value:
      then:
        - lambda: |-
            float current_target = id(smoker_pid).target_temperature;
            float new_target = current_target + (x * 5);  // 5 degree increments
            new_target = std::max(150.0f, std::min(700.0f, new_target));
            auto call = id(smoker_pid).make_call();
            call.set_target_temperature(new_target);
            call.perform();
            id(setpoint_encoder).publish_state(0);  // Reset encoder

# PWM output for fan
output:
  - platform: ledc
    pin: GPIO16
    id: fan_output
    frequency: 25000Hz
    min_power: 0.0
    max_power: 1.0

  # Beeper output
  - platform: gpio
    pin: GPIO4
    id: beeper_output

# Fan speed control (for monitoring)
number:
  - platform: template
    name: "Fan Speed"
    id: fan_speed
    min_value: 0
    max_value: 100
    step: 1
    unit_of_measurement: "%"
    mode: slider

# Climate component (PID controller)
climate:
  - platform: pid
    name: "Smoker PID"
    id: smoker_pid
    sensor: smoker_temp
    default_target_temperature: 225°F
    heat_output: fan_output
    
    # PID tuning parameters - THESE NEED TUNING!
    control_parameters:
      kp: 0.5
      ki: 0.001
      kd: 10.0
      output_averaging_samples: 5
      derivative_averaging_samples: 5
    
    # Temperature limits
    visual:
      min_temperature: 150°F
      max_temperature: 700°F
      temperature_step: 5°F
    
    # Deadband to prevent oscillation
    deadband_parameters:
      threshold_high: 2°F
      threshold_low: -2°F
    
    on_state:
      - lambda: |-
          float output = id(fan_output).get_state() * 100;
          id(fan_speed).publish_state(output);

# Text sensors for display
text_sensor:
  - platform: template
    name: "Error Code"
    id: error_text
    lambda: |-
      return id(error_code);

# Switches
switch:
  - platform: template
    name: "Door Override"
    id: door_override_switch
    lambda: |-
      return id(door_override);
    turn_on_action:
      - globals.set:
          id: door_override
          value: 'true'
      - logger.log: "Door override enabled via switch"
    turn_off_action:
      - globals.set:
          id: door_override
          value: 'false'
      - logger.log: "Door override disabled via switch"

# Scripts
script:
  - id: alert_sos
    mode: single
    then:
      # S: dot dot dot (3 short beeps)
      - output.turn_on: beeper_output
      - delay: 150ms
      - output.turn_off: beeper_output
      - delay: 150ms
      - output.turn_on: beeper_output
      - delay: 150ms
      - output.turn_off: beeper_output
      - delay: 150ms
      - output.turn_on: beeper_output
      - delay: 150ms
      - output.turn_off: beeper_output
      - delay: 350ms  # Gap between letters
      
      # O: dash dash dash (3 long beeps)
      - output.turn_on: beeper_output
      - delay: 450ms
      - output.turn_off: beeper_output
      - delay: 150ms
      - output.turn_on: beeper_output
      - delay: 450ms
      - output.turn_off: beeper_output
      - delay: 150ms
      - output.turn_on: beeper_output
      - delay: 450ms
      - output.turn_off: beeper_output
      - delay: 350ms  # Gap between letters
      
      # S: dot dot dot (3 short beeps)
      - output.turn_on: beeper_output
      - delay: 150ms
      - output.turn_off: beeper_output
      - delay: 150ms
      - output.turn_on: beeper_output
      - delay: 150ms
      - output.turn_off: beeper_output
      - delay: 150ms
      - output.turn_on: beeper_output
      - delay: 150ms
      - output.turn_off: beeper_output
      - delay: 1000ms  # Long pause before repeat

  - id: update_displays
    mode: single
    then:
      - lambda: |-
          // Display 1: Current Temperature
          // Display 2: Setpoint Temperature
          // This is a placeholder - actual TM1637 display code will go here
          // For now, log the values
          ESP_LOGI("display", "Current: %.1f°F, Setpoint: %.1f°F", 
                   id(smoker_temp).state, 
                   id(smoker_pid).target_temperature);

# Interval for periodic updates
interval:
  - interval: 1s
    then:
      - script.execute: update_displays
      
  # Check for fan failure every 5 seconds
  - interval: 5s
    then:
      - lambda: |-
          if (id(smoker_pid).mode != CLIMATE_MODE_OFF && 
              id(fan_speed).state > 20 && 
              id(fan_rpm).state < 300) {
            id(error_code) = "ERF";
          } else if (id(error_code) == "ERF" && id(fan_rpm).state >= 300) {
            id(error_code) = "";  // Clear error
          }
